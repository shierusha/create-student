<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜玩家中心</title>
  <link rel="stylesheet" href="player.css">
</head>
<body>
  <div class="center">
    <h2 id="player-welcome">歡迎玩家！</h2>
    <div style="display: flex; flex-direction: column; gap: 1.2em; margin: 2em 0;">
      <button onclick="location.href='player_manage'">角色管理</button>
    
<button id="go-gacha-btn" style="background: #cd4747;" onclick="goGacha()">前往扭蛋</button>

      <button id="create-btn" onclick="location.href='https://shierusha.github.io/create-student/stidcard/shierusha-stu'">創角</button>
  <button onclick="window.open('https://shierusha.github.io/school-battle/students/AllStu', '_blank')">學生名冊</button>

  <button onclick="window.open('https://shierusha.github.io/create-student/thanks/thanks', '_blank')">感謝名冊</button>
      <button style="background: #999;" onclick="logout()">登出</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase 初始化
    const client = window.supabase.createClient(
      'https://wfhwhvodgikpducrhgda.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
    );
//----------------------

  // 設定特例可多創角的 player_id
const EXEMPT_PLAYER_IDS = [
  '47c190ba-ac90-42b0-a2a5-402ae7975223', // 梨兒
  '94cea572-5f6c-42b2-9c7b-b7015c0b8e6a', // 碎兒
  'aa03ee8f-9150-41d7-a196-c6e177469c3b', // 101101010兒
  'e8cf92ac-69f4-4d36-bc74-821c9fec2ab8', // 精靈兒
  'd57d87ac-3892-4794-b3e4-243088672b5c', // 夢兒
  '7a4ce2d2-9329-4192-a886-7b15111d21e8'  // 咕兒
];

// 檢查玩家登入＋角色上限
async function checkPlayer() {
  let { data: { user } } = await client.auth.getUser();
  if (!user) {
    location.href = 'https://shierusha.github.io/login/login'; return;
  }
  // 查玩家名字＋身分＋player_id
  let { data, error } = await client
    .from('players')
    .select('username, role, player_id')
    .eq('email', user.email)
    .single();
  if (error || !data) {
    location.href = 'https://shierusha.github.io/login/login'; return;
  }
  // 如果是 admin，直接跳到 admin 頁
  if (data.role === 'admin') {
    location.href = 'https://shierusha.github.io/login/admin';
    return;
  }
  // 正常玩家才會顯示歡迎詞
  document.getElementById('player-welcome').textContent = `歡迎 ${data.username} 玩家`;

  // 查角色數量
  let { count } = await client
    .from('students')
    .select('*', { count: 'exact', head: true })
    .eq('player_id', data.player_id);

  // 決定角色上限
  let limit = EXEMPT_PLAYER_IDS.includes(data.player_id) ? 5 : 4;
  let createBtn = document.querySelector('button[onclick*="create-student"]') || document.querySelector('button[onclick*="創角"]');
  if (count >= limit) {
    createBtn.disabled = true;
    createBtn.style.background = '#bbb';
    createBtn.style.cursor = 'not-allowed';
    createBtn.textContent = `創角（已達上限）`;
  } else {
    createBtn.disabled = false;
    createBtn.style.background = '';
    createBtn.style.cursor = '';
    createBtn.textContent = `創角`;
  }
}

//----------------------
 
    // 登出
    async function logout() {
      await client.auth.signOut();
      location.href = 'https://shierusha.github.io/login/login';
    }
    checkPlayer();
  </script>





<script>
  const EXCHANGE_URL = 'https://ogzpfrkwnqqaitytncla.supabase.co/functions/v1/exchange-token';

  async function goGacha() {
    // 1) A 專案 Session
    const { data: { session } } = await client.auth.getSession();
    if (!session?.access_token) { alert('請先登入'); return; }

    // 2) 準備顯示用名稱（只存在 localStorage）
    //   優先 players.username，否則 email 前綴，再不行用「玩家」
    let username = '玩家';
    try {
      const { data: me } = await client
        .from('players')
        .select('username, email')
        .eq('email', session.user.email)
        .single();

      if (me?.username && me.username.trim()) {
        username = me.username.trim();
      } else if (me?.email) {
        username = String(me.email).split('@')[0] || '玩家';
      }
    } catch (_) {}

    // 3) 用 A 的 access_token 向 B 的 exchange-token 換短期 JWT
    const resp = await fetch(EXCHANGE_URL, {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify({ token: session.access_token })
    });
    const data = await resp.json();
    if (!resp.ok || !data?.token) {
      console.error('exchange-token failed:', data);
      alert('交換 Token 失敗'); return;
    }

    // 4) 只存前端資料（名字存在 localStorage，不寫入 B 資料庫）
    localStorage.setItem('gacha_b_jwt', data.token);
    localStorage.setItem('gacha_b_jwt_exp', String(data.exp || 0));
    localStorage.setItem('gacha_b_user', data.sub || '');
    localStorage.setItem('gacha_player_name', username);  // ★ 只靠這個顯示名字
    localStorage.setItem('gacha_app_role', data.role || 'PLAYER');


    // 5) 進扭蛋頁
    location.href = 'https://shierusha.github.io/library/gacha';
  }

  // 登出時也把扭蛋用的暱稱清掉，避免換帳殘留
  async function logout() {
    await client.auth.signOut();
    localStorage.removeItem('gacha_b_jwt');
    localStorage.removeItem('gacha_b_jwt_exp');
    localStorage.removeItem('gacha_b_user');
    localStorage.removeItem('gacha_player_name');
    location.href = 'https://shierusha.github.io/login/login';
  }
</script>



</body>
</html>
