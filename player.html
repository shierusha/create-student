<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>謝爾夏｜玩家中心</title>
  <link rel="stylesheet" href="player.css" />
  <style>
    /* ====== 新增：分頁（TAB）樣式 ====== */
    .tabs { margin-top: 1.2rem; }
    .tablist {
      display: flex; gap: .5rem; justify-content: center; margin-bottom: .9rem;
    }
    .tab-btn[role="tab"] {
      background: #eef3fb; color: var(--soft-blue);
      border: 1px solid #cfe0ff; border-radius: 999px;
      padding: .55rem 1rem; font-weight: 700; cursor: pointer;
    }
    .tab-btn[aria-selected="true"] {
      background: var(--main-blue); color: var(--white); border-color: var(--main-blue);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* 內文的按鈕群 */
    .btn-col {
      display: flex; flex-direction: column;
      gap: 1.2em; margin: 1.2em 0 0 0;
    }

    /* 扭蛋按鈕維持原本紅色 */
    #go-gacha-btn { background: #cd4747; }

    /* 小螢幕優化：讓 TAB 橫向可捲動 */
    @media (max-width: 480px) {
      .tablist { overflow-x: auto; padding-bottom: .2rem; }
      .tablist::-webkit-scrollbar { height: 6px; }
    }
  </style>
</head>
<body>
  <div class="center">
    <h2 id="player-welcome">歡迎玩家！</h2>

    <!-- ====== 分頁（TAB） ====== -->
    <div class="tabs" id="player-tabs">
      <div class="tablist" role="tablist" aria-label="玩家中心功能分類">
        <button id="tab-roles" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-roles" tabindex="0">
          角色相關
        </button>
        <button id="tab-others" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-others" tabindex="-1">
          其他系統
        </button>
      </div>

      <!-- 角色相關 -->
      <div id="panel-roles" class="tab-panel active" role="tabpanel" aria-labelledby="tab-roles" tabindex="0">
        <div class="btn-col">
          <button onclick="location.href='player_manage'">管理角色</button>

          <button id="create-btn" onclick="location.href='https://shierusha.github.io/create-student/stidcard/shierusha-stu'">
            創角
          </button>

          <button onclick="window.open('https://shierusha.github.io/library/lib/allskill','_blank')">
            技能一覽
          </button>

          <button onclick="window.open('https://shierusha.github.io/school-battle/students/AllStu','_blank')">
            學生名冊
          </button>

          <button onclick="window.open('https://shierusha.github.io/library/lib/allicd?idc=%E6%95%99%E5%B8%AB%E8%AD%89','_blank')">
            教師名冊
          </button>

          <button style="background:#999;" onclick="logout()">登出</button>
        </div>
      </div>

      <!-- 其他系統 -->
      <div id="panel-others" class="tab-panel" role="tabpanel" aria-labelledby="tab-others" tabindex="0">
        <div class="btn-col">
          <button id="go-gacha-btn" onclick="goGacha()">前往扭蛋</button>

          <button onclick="window.open('https://shierusha.github.io/library/story/story','_blank')">
            前往休息室
          </button>

          <button style="background:#999;" onclick="logout()">登出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase 初始化
    const client = window.supabase.createClient(
      'https://wfhwhvodgikpducrhgda.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
    );

    // 特例：可多創角的 player_id
    const EXEMPT_PLAYER_IDS = [
      '47c190ba-ac90-42b0-a2a5-402ae7975223', // 梨兒
      '94cea572-5f6c-42b2-9c7b-b7015c0b8e6a', // 碎兒
      'aa03ee8f-9150-41d7-a196-c6e177469c3b', // 101101010兒
      'e8cf92ac-69f4-4d36-bc74-821c9fec2ab8', // 精靈兒
      'd57d87ac-3892-4794-b3e4-243088672b5c', // 夢兒
      '7a4ce2d2-9329-4192-a886-7b15111d21e8'  // 咕兒
    ];

    // 檢查玩家登入＋角色上限
    async function checkPlayer() {
      const { data: { user } } = await client.auth.getUser();
      if (!user) { location.href = 'https://shierusha.github.io/login/login'; return; }

      // 取玩家資料
      const { data, error } = await client
        .from('players')
        .select('username, role, player_id, email')
        .eq('email', user.email)
        .single();

      if (error || !data) { location.href = 'https://shierusha.github.io/login/login'; return; }

      // 管理員導向
      if (data.role === 'admin') { location.href = 'https://shierusha.github.io/login/admin'; return; }

      // 歡迎詞
      document.getElementById('player-welcome').textContent = `歡迎 ${data.username} 玩家`;

      // 查角色數量
      const { count } = await client
        .from('students')
        .select('*', { count: 'exact', head: true })
        .eq('player_id', data.player_id);

      // 決定角色上限
      const limit = EXEMPT_PLAYER_IDS.includes(data.player_id) ? 5 : 4;
      const createBtn = document.getElementById('create-btn');

      if (createBtn) {
        if ((count ?? 0) >= limit) {
          createBtn.disabled = true;
          createBtn.style.background = '#bbb';
          createBtn.style.cursor = 'not-allowed';
          createBtn.textContent = '創角（已達上限）';
        } else {
          createBtn.disabled = false;
          createBtn.style.background = ''; // 還原
          createBtn.style.cursor = '';
          createBtn.textContent = '創角';
        }
      }
    }

    // ====== TAB 行為（可用 #others 直達第二分頁） ======
    function initTabs() {
      const tabs = Array.from(document.querySelectorAll('.tab-btn[role="tab"]'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));

      function activate(tabId) {
        tabs.forEach(btn => {
          const selected = btn.id === tabId;
          btn.setAttribute('aria-selected', selected ? 'true' : 'false');
          btn.tabIndex = selected ? 0 : -1;
        });
        panels.forEach(p => {
          p.classList.toggle('active', p.getAttribute('aria-labelledby') === tabId);
        });
      }

      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          activate(btn.id);
          // 更新網址 hash（可分享）
          if (btn.id === 'tab-others') location.hash = 'others';
          else history.replaceState(null, '', location.pathname);
        });
        btn.addEventListener('keydown', (e) => {
          const idx = tabs.indexOf(btn);
          if (e.key === 'ArrowRight') { (tabs[idx + 1] || tabs[0]).focus(); }
          if (e.key === 'ArrowLeft')  { (tabs[idx - 1] || tabs[tabs.length - 1]).focus(); }
          if (e.key === 'Enter' || e.key === ' ') { btn.click(); }
        });
      });

      // hash 決定預設分頁
      if (location.hash.replace('#','') === 'others') {
        activate('tab-others');
      } else {
        activate('tab-roles');
      }
    }

    // ====== 扭蛋交換 Token 並前往 ======
    const EXCHANGE_URL = 'https://ogzpfrkwnqqaitytncla.supabase.co/functions/v1/exchange-token';

    async function goGacha() {
      const { data: { session } } = await client.auth.getSession();
      if (!session?.access_token) { alert('請先登入'); return; }

      // 顯示用名稱（只存在 localStorage）
      let username = '玩家';
      try {
        const { data: me } = await client
          .from('players')
          .select('username, email')
          .eq('email', session.user.email)
          .single();

        if (me?.username?.trim()) username = me.username.trim();
        else if (me?.email) username = String(me.email).split('@')[0] || '玩家';
      } catch (_) {}

      // A 專案 access_token 換 B 的短期 JWT
      const resp = await fetch(EXCHANGE_URL, {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({ token: session.access_token })
      });
      const data = await resp.json();
      if (!resp.ok || !data?.token) {
        console.error('exchange-token failed:', data);
        alert('交換 Token 失敗'); return;
      }

      // 存前端資料（不寫入 B 資料庫）
      localStorage.setItem('gacha_b_jwt', data.token);
      localStorage.setItem('gacha_b_jwt_exp', String(data.exp || 0));
      localStorage.setItem('gacha_b_user', data.sub || '');
      localStorage.setItem('gacha_player_name', username);  // 顯示名字
      localStorage.setItem('gacha_app_role', data.role || 'PLAYER');

      // 進扭蛋頁
      location.href = 'https://shierusha.github.io/library/gacha';
    }

    // 登出（同時清掉扭蛋暱稱等）
    async function logout() {
      await client.auth.signOut();
      localStorage.removeItem('gacha_b_jwt');
      localStorage.removeItem('gacha_b_jwt_exp');
      localStorage.removeItem('gacha_b_user');
      localStorage.removeItem('gacha_player_name');
      location.href = 'https://shierusha.github.io/login/login';
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      checkPlayer();
    });
  </script>
</body>
</html>
