<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜角色管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CropperJS CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css"/>
<!-- CropperJS JS -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>


  
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7fa; margin: 0; padding: 2rem; }
    .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 1.3rem; box-shadow: 0 2px 16px #0001; }
    h2 { text-align: center; margin-bottom: 1.3rem; }
    .msg { min-height: 1.5em; margin-bottom: 0.8em; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
    th, td { border-bottom: 1px solid #eef2fa; padding: 0.44em 0.63em; text-align: left; }
    th { background: #f4f7fa; font-size: 1em;}
    .btn { background: #1767a0; color: #fff; border: none; border-radius: 0.5em; padding: 0.3em 0.8em; font-weight: 600; cursor: pointer; margin-right: 0.2em;}
    .btn-edit { background: #21694b;}
    .btn-link { background: #346689;}
    /* Dialog */
    .modal-bg {
      display: none; position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.22); z-index: 1001;
      justify-content:center; align-items: center;
    }
    .modal {
      background: #fff; border-radius: 1em; max-width: 85%; min-width: 25%; padding: 2em 1.5em;
      box-shadow: 0 4px 24px #0004; position: relative; 
    }
    .modal h3 { margin-top: 0; margin-bottom: 1em;}
    .modal .note-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7em;}
    .modal .note-content { flex: 1; margin-right: 1em;  white-space: pre-line;  /* 讓 \n 換行 */
  word-break: break-all;  /* 長字也會自動換行 */}
    .modal input[type="checkbox"] { transform: scale(1.2); }
    .modal .close-btn { position: absolute; top: 0.6em; right: 1em; background: none; border:none; font-size:1.6em; color:#999; cursor:pointer;}
    .modal .modal-actions { margin-top: 1.3em; text-align: right;}
    .modal .btn {margin:0;}

    @media (max-width: 650px) {
      .container {padding: 1em;}
      .modal {padding: 1.2em;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h2>角色管理</h2>
    <span class="msg" id="msg"></span>
    <div class="table-wrap">
      <table id="data-table">
        <thead>
          <tr>
            <th>名字</th>
            <th>性別</th>
            <th>陣營</th>
            <th>狀態</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="data-tbody">
        </tbody>
      </table>
    </div>
    <div style="text-align: right;">
<button class="btn" id="back-btn" onclick="goBack()">返回</button>
    </div>
  </div>
  <!-- Modal Dialog -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal" id="modal">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h3>公開狀態設定</h3>
      <div id="notes-list"></div>
      <div class="modal-actions">
        <button class="btn btn-edit" onclick="saveNotes()">儲存</button>
      </div>
    </div>
  </div>





<!-- Modal 內容 -->
<div class="modal-bg" id="upload-modal-bg" style="display:none;">
  <div class="modal">
    <button class="close-btn" onclick="closeUploadModal()">×</button>
    <h3>上傳照片</h3>
    <div style="text-align:center;">
      <img id="cropper-img" src="" alt="預覽" style="max-width:100%;max-height:350px;">
    </div>
    <form id="upload-form">
      <input type="file" id="upload-file" accept="image/*" required>
      <div id="upload-msg" style="color:#1d4076;min-height:1em;margin-bottom:1em;"></div>
      <div class="modal-actions">
        <button type="submit" class="btn">上傳</button>
      </div>
    </form>
  </div>
</div>




  
<script>
  // ====== Supabase 設定 ======
  const client = window.supabase.createClient(
    'https://wfhwhvodgikpducrhgda.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
  );

  let user = null, player = null, myStudents = [], reviewMap = {}, userRole = "player";

  async function init() {
    setMsg('載入中...');
    // 檢查登入
    let { data: userData } = await client.auth.getUser();
    if (!userData.user) {
      location.href = 'login.html'; return;
    }
    user = userData.user;
    // 查玩家，加入 role 欄位
    let { data: players, error: pErr } = await client.from('players').select('player_id,username,role').eq('email', user.email).single();
    if (pErr || !players) {
      location.href = 'login.html'; return;
    }
    player = players;
    userRole = players.role || "player";

    // 查所有我的學生（角色）
    let { data: students, error: sErr } = await client.from('students')
      .select('student_id,name,gender,alignment')
      .eq('player_id', player.player_id);
    if (sErr) { setMsg('角色載入失敗'); return; }
    myStudents = students || [];

    // 查所有審核狀態
    let { data: reviews } = await client.from('student_reviews')
      .select('student_id,status');
    reviewMap = {};
    (reviews||[]).forEach(r=>{ reviewMap[r.student_id]=r.status; });
    renderTable();
    setMsg('');
  }

  function renderTable() {
    const tbody = document.getElementById('data-tbody');
    tbody.innerHTML = '';
    myStudents.forEach(stu => {
      const reviewStatus = getReviewStatus(reviewMap[stu.student_id]);
      tbody.innerHTML += `
        <tr>
          <td>${stu.name}</td>
          <td>${getGender(stu.gender)}</td>
          <td>${getAlignment(stu.alignment)}</td>
          <td>${reviewStatus}</td>
          <td>
            <button class="btn btn-link" onclick="openStudentCard('${stu.student_id}')">學生證</button>
            <button class="btn btn-edit" onclick="openNotesModal('${stu.student_id}')">公開設定</button>
            <button class="btn" onclick="openUploadModal('${stu.student_id}')">上傳照片</button>

          </td>
        </tr>
      `;
    });
  }

  function getGender(g) {
    if (g === "M") return "男";
    if (g === "F") return "女";
    if (g === "O") return "其他";
    return "-";
  }
  function getAlignment(a) {
    if (a === "white") return "白";
    if (a === "black") return "黑";
    return a || "-";
  }
  function getReviewStatus(s) {
    if (s === "WAIT") return "審核中";
    if (s === "PASS") return "已通過";
    if (s === "BAD") return "未通過";
    return "未審核";
  }

  // 學生證連結（你可以改成你的學生證網址規則）
function openStudentCard(student_id) {
  window.open(`https://shierusha.github.io/create-student/stidcard/shierusha-stu?stu=${student_id}`, "_blank");
}

  // ========== 公開設定 Modal ==========
  let currentStuId = null, notesCache = [];
  async function openNotesModal(student_id) {
    currentStuId = student_id;
    document.getElementById('modal-bg').style.display = 'flex';
    setModalMsg("載入中...");
    // 查這角色的所有筆記
    let { data: notes, error } = await client.from('student_notes')
      .select('note_id,content,is_public')
      .eq('student_id', student_id);
    notesCache = notes || [];
    renderNotesList();
    setModalMsg("");
  }
  function closeModal() {
    document.getElementById('modal-bg').style.display = 'none';
    notesCache = [];
    currentStuId = null;
  }
  function renderNotesList() {
    let html = '';
    if (!notesCache.length) html = '<div style="color:#888;">沒有筆記</div>';
    notesCache.forEach(n => {
      html += `
        <div class="note-row">
          <div class="note-content">${n.content}</div>
          <input type="checkbox" ${n.is_public ? 'checked' : ''} data-nid="${n.note_id}" onchange="toggleNotePublic(this)">
          <label>公開</label>
        </div>
      `;
    });
    document.getElementById('notes-list').innerHTML = html;
  }
  function toggleNotePublic(cb) {
    const nid = cb.getAttribute('data-nid');
    const note = notesCache.find(n => n.note_id === nid);
    if (note) note.is_public = cb.checked;
  }
  async function saveNotes() {
    setModalMsg("儲存中...");
    let ok = true;
    for (let n of notesCache) {
      let { error } = await client.from('student_notes').update({ is_public: n.is_public }).eq('note_id', n.note_id);
      if (error) ok = false;
    }
    setModalMsg(ok ? "儲存完成！" : "部分筆記儲存失敗");
    setTimeout(closeModal, 900);
  }
  function setMsg(msg) {
    document.getElementById('msg').textContent = msg || '';
  }
  function setModalMsg(msg) {
    document.getElementById('notes-list').style.color = msg ? "#1d4076" : "";
    if (msg) document.getElementById('notes-list').innerHTML = msg;
  }

  // 返回按鈕分流
  function goBack() {
    if (userRole === "admin") {
      location.href = 'https://shierusha.github.io/login/admin.html';
    } else {
      location.href = 'player.html';
    }
  }

  window.openStudentCard = openStudentCard;
  window.openNotesModal = openNotesModal;
  window.closeModal = closeModal;
  window.toggleNotePublic = toggleNotePublic;
  window.saveNotes = saveNotes;
  window.goBack = goBack;

  init();


let cropper = null;
let uploadStuId = null;

// 打開 modal，設定目前 student id
function openUploadModal(student_id) {
  uploadStuId = student_id;
  document.getElementById('upload-modal-bg').style.display = 'flex';
  document.getElementById('upload-form').reset();
  document.getElementById('cropper-img').src = '';
  if (cropper) { cropper.destroy(); cropper = null; }
  setUploadMsg('');
}

function closeUploadModal() {
  document.getElementById('upload-modal-bg').style.display = 'none';
  uploadStuId = null;
  if (cropper) { cropper.destroy(); cropper = null; }
}

function setUploadMsg(msg) {
  document.getElementById('upload-msg').textContent = msg || '';
}

// 1. 處理使用者選擇檔案
document.getElementById('upload-file').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    const img = document.getElementById('cropper-img');
    img.src = evt.target.result;

    if (cropper) cropper.destroy();

    // 2. 初始化 Cropper
    cropper = new Cropper(img, {
      aspectRatio: 8 / 9, // 這就是你要的長寬比
      viewMode: 1,
      background: false,
      movable: true,
      zoomable: true,
      rotatable: true,
      cropBoxResizable: true
    });
  }
  reader.readAsDataURL(file);
}

// 3. 上傳表單送出
document.getElementById('upload-form').onsubmit = async function(e) {
  e.preventDefault();
  setUploadMsg('上傳中...');
  if (!cropper || !uploadStuId) { setUploadMsg('請選擇圖片'); return; }

  // 取得裁切後的圖片（你要的寬高，這裡範例 400x450）
  cropper.getCroppedCanvas({ width: 400, height: 450 }).toBlob(async function(blob) {
    // 組成 storage 檔名
    const ext = 'png';
    const filePath = `student-images/${uploadStuId}/front.${ext}`;

    // 移除舊檔案（同名檔案會直接覆蓋，這步可省略）
    await client.storage.from('public').remove([filePath]);

    // 上傳 storage
    const { error: uploadErr } = await client.storage
      .from('public')
      .upload(filePath, blob, { upsert: true });

    if (uploadErr) { setUploadMsg('圖片上傳失敗'); return; }

    // 拿 publicUrl
    const { data: { publicUrl } } = client.storage.from('public').getPublicUrl(filePath);

    // 刪除舊資料表資料
    await client.from('student_images')
      .delete()
      .eq('student_id', uploadStuId)
      .eq('image_type', 'front');

    // 新增資料表
    const { error: insertErr } = await client.from('student_images').insert([
      {
        student_id: uploadStuId,
        image_type: 'front',
        image_url: publicUrl,
        uploaded_by: player.player_id
      }
    ]);
    if (insertErr) { setUploadMsg('資料寫入失敗'); return; }

    setUploadMsg('上傳完成！');
    setTimeout(closeUploadModal, 1200);
  }, 'image/png');
}

</script>

</body>
</html>
