<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜角色管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: 'Noto Sans TC', sans-serif;
  background: #f4f7fa;
  margin: 0;
  padding: 2rem;
}
.container {
  max-width: 950px;
  margin: auto;
  background: white;
  padding: 2rem;
  border-radius: 1.3rem;
  box-shadow: 0 2px 16px #0001;
}
h2 { text-align: center; margin-bottom: 1.3rem; }
.msg { min-height: 1.5em; margin-bottom: 0.8em; }

/* ---- 卡片區 ---- */
.student-list {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 2.3rem 1.3rem;
  margin-top: 1.5em;
}
.student-card {
  border-radius: 1.1em;
  padding: 1.5em 1.3em 1.2em 1.3em;
  box-shadow: 0 2px 10px #0002;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 0;
  transition: box-shadow .18s;
}
.card-w { background: #f9fbfe; }
.card-b { background: #27364f; }
.card-b .student-name,
.card-b .btn-link,
.card-b .btn-edit,
.card-b .btn {
  color: #fff;
}
.card-b .btn-link,
.card-b .btn-edit,
.card-b .btn {
  background: #3d4b63;
  border-color: #27364f;
}
.card-b .btn-link:disabled,
.card-b .btn-edit:disabled,
.card-b .btn:disabled {
  opacity: 0.6;
}

.avatar-frame {
  width: 110px; height: 110px;
  border-radius: 1em;
  overflow: hidden;
  background: #e7e8f3;
  margin-bottom: 1em;
  display: flex; align-items: center; justify-content: center;
}
.avatar-img {
  width: 110px; height: 110px; object-fit: cover;
  background: #e2e2e2;
}
.student-info {
  width: 100%;
  text-align: center;
}
.student-name {
  font-size: 1.15em;
  font-weight: bold;
  min-height: 2.7em;
  line-height: 1.2em;
  margin-bottom: 0.4em;
  word-break: break-all;
  letter-spacing: .04em;
}

.card-btn-group {
  width: 80%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.55em;
}
.card-btn-group .btn {
  min-width: 90px;
  width: 100%;
  max-width: 220px;
  margin: 0.18em 0;
}
.btn {
  background: #1767a0;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.3em 0.8em;
  font-weight: 600;
  cursor: pointer;
  margin-right: 0.2em;
  transition: background .15s;
}
.btn-edit { background: #21694b; }
.btn-link { background: #346689; }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* ------------ 響應式 (手機) ------------ */
@media (max-width: 600px) {
  .student-list {
    grid-template-columns: repeat(2, 1fr);
  }
  .container { padding: 1em; }
  .student-card { padding: 1.2em 0.7em 1em 0.7em; }
}

/* ----------- Modal 相關 ----------- */
.modal-bg {
  display: none;
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.22);
  z-index: 1001;
  justify-content: center;
  align-items: center;
}
.modal-bg[style*="flex"], .modal-bg[style*="display: flex"] { display: flex !important; }
.modal {
  position: relative;
  background: #fff;
  border-radius: 1em;
  max-width: 97vw;
  min-width: 240px;
  width: 420px;
  box-sizing: border-box;
  padding: 2em 1.5em;
  box-shadow: 0 4px 24px #0004;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ======= canvas 區 ======= */
#canvas-wrap {
  position: relative;
  width: 100%;
  max-width: 400px;
  aspect-ratio: 8 / 9;
  margin: auto;
  display: flex;
  justify-content: center;
  align-items: center;
  background: transparent;
}
#edit-canvas {
  width: 100% !important;
  height: 100% !important;
  max-width: 400px;
  max-height: 450px;
  display: block;
  background: #ddd;
  border-radius: 0.7em;
}
#redbox-frame {
  position: absolute;
  left: 0; top: 0;
  width: 100% !important;
  height: 100% !important;
  max-width: 400px;
  max-height: 450px;
  pointer-events: none;
  z-index: 10;
  object-fit: contain;
  display: block;
}

@media (max-width: 500px) {
  .modal {
    width: 99vw;
    padding: 1em 0.2em;
    min-width: 0;
    max-width: 99vw;
  }
  #canvas-wrap {
    max-width: 99vw;
    aspect-ratio: 8 / 9;
  }
}

.close-btn {
  position: absolute; top: 0.6em; right: 1em;
  background: none; border: none; font-size: 1.6em; color: #999; cursor: pointer; z-index: 1001;
}
.close-btn:hover { color:#e2583e; }
.hint { font-size: 0.95em; color: #888; margin-top: 0.7em; }

</style>
</head>
<body>
 
    <div class="container">
    <h2>角色一覽表</h2>
    <span class="msg" id="msg"></span>
    <div id="student-list" class="student-list"></div>
    <div style="text-align: right; margin-top:1.2em;">
      <button class="btn" id="back-btn" onclick="goBack()">返回</button>
    </div>
  </div>

  <!-- 上傳正面照 Modal -->
  <div class="modal-bg" id="upload-modal-bg" style="display:none;">
    <div class="modal">
      <button class="close-btn" onclick="closeUploadModal()">×</button>
      <h3 style="text-align:center;">上傳照片</h3>
      <div id="canvas-wrap">
        <canvas id="edit-canvas" width="400" height="450"></canvas>
        <img src="https://shierusha.github.io/create-student/imgs/export-0.png" 
             id="redbox-frame" alt="紅框定位圖">
      </div>
      <input type="file" id="upload-file" accept="image/*"><br>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="toggleMirror()">鏡射</button>
        <button type="button" class="btn" onclick="submitCanvasImage()">儲存上傳</button>
      </div>
      <div id="upload-msg"></div>
      <div class="hint">電腦可用 AD旋轉 滑鼠滾輪拖移放大縮小<br>手機可用手指縮放、旋轉、移動照片對好臉再上傳</div>
    </div>
  </div>
  <script>

  // ========== Supabase 設定 ==========
const client = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);

const TEST_STUDENT_IDS = [
  '24e1a631-016a-422a-9f27-a6e5774c254f',
  '434cbc99-9a4f-4334-bc71-7236b8daf51c',
  '6ceb01f3-d296-438f-be5a-eebfa6e30e41',
  '845dd04d-ff39-43a8-ad84-e8f714a8b454',
  'ee8ea0cd-d664-4b5f-8d0e-0240bf9debdb'
];

let user = null, player = null, myStudents = [], reviewMap = {}, imgMap = {}, userRole = "player";


//鏡射
let mirrored = false; // 預設不鏡射

function drawCanvas() {
  ctx.clearRect(0,0,400,450);
  if (!img) return;
  ctx.save();
  ctx.translate(imgX, imgY);
  ctx.rotate(rotation);
  ctx.scale(mirrored ? -scale : scale, scale);
  ctx.drawImage(img, -img.width/2, -img.height/2);
  ctx.restore();
}
function toggleMirror() {
  mirrored = !mirrored;
  drawCanvas();
}
window.toggleMirror = toggleMirror;

// canvas / modal 相關
let uploadStuId = null;
let img = null;
let imgX = 200, imgY = 225, scale = 1, rotation = 0;
let dragging = false, lastX, lastY;
let pinchStart = null, pinchInit = {};
const canvas = document.getElementById('edit-canvas');
const ctx = canvas.getContext('2d');

function setMsg(msg) {
  document.getElementById('msg').textContent = msg || '';
}
function setUploadMsg(msg) {
  document.getElementById('upload-msg').textContent = msg || '';
}

// 取得最新學生照片map
async function reloadImages() {
  let { data: imgs } = await client.from('student_images')
    .select('student_id,image_url')
    .eq('image_type', 'front');
  imgMap = {};
  (imgs||[]).forEach(im=>{ imgMap[im.student_id]=im.image_url; });
}

// avatar 預覽裁切（左上角）
function getAvatarFromUrl(url, callback) {
  let avatarCanvas = document.createElement('canvas');
  avatarCanvas.width = avatarCanvas.height = 300;
  let ctx = avatarCanvas.getContext('2d');
  let img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = function() {
    ctx.clearRect(0,0,300,300);
    ctx.drawImage(img, 0, 0, 300, 300, 0, 0, 300, 300);
    callback(avatarCanvas.toDataURL('image/png'));
  };
  img.onerror = function() {
    callback(""); // fallback 頭像
  }
  img.src = url;
}

// canvas控制
function drawCanvas() {
  ctx.clearRect(0,0,400,450);
  if (!img) return;
  ctx.save();
  ctx.translate(imgX, imgY);
  ctx.rotate(rotation);
  ctx.scale(scale, scale);
  ctx.drawImage(img, -img.width/2, -img.height/2);
  ctx.restore();
}
document.getElementById('upload-file').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    img = new Image();
    img.onload = function() {
      imgX = 200; imgY = 225; scale = Math.max(400/img.width, 450/img.height); rotation = 0;
      drawCanvas();
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
};
canvas.onmousedown = function(e){
  if(!img) return;
  dragging = true;
  lastX = e.offsetX;
  lastY = e.offsetY;
};
canvas.onmouseup = canvas.onmouseleave = ()=>dragging=false;
canvas.onmousemove = function(e){
  if(!dragging) return;
  imgX += e.offsetX - lastX;
  imgY += e.offsetY - lastY;
  lastX = e.offsetX; lastY = e.offsetY;
  drawCanvas();
};
canvas.onwheel = function(e){
  if(!img) return;
  e.preventDefault();
  let factor = (e.deltaY < 0) ? 1.04 : 0.96;
  scale *= factor;
  drawCanvas();
};
window.onkeydown = function(e){
  if(!img) return;
  if(e.key==='a') {rotation -= Math.PI/60; drawCanvas();}
  if(e.key==='d') {rotation += Math.PI/60; drawCanvas();}
};
canvas.addEventListener('touchstart', function(e){
  if(!img) return;
  if(e.touches.length===1) {
    dragging = true;
    let rect = canvas.getBoundingClientRect();
    lastX = e.touches[0].clientX - rect.left;
    lastY = e.touches[0].clientY - rect.top;
  }
  if(e.touches.length===2) {
    pinchStart = [
      {x:e.touches[0].clientX, y:e.touches[0].clientY},
      {x:e.touches[1].clientX, y:e.touches[1].clientY}
    ];
    pinchInit = {scale, rotation, imgX, imgY};
  }
}, {passive:false});
canvas.addEventListener('touchend', function(e){
  dragging = false; pinchStart=null;
}, {passive:false});
canvas.addEventListener('touchmove', function(e){
  if(!img) return;
  e.preventDefault();
  let rect = canvas.getBoundingClientRect();
  if(e.touches.length===1 && dragging) {
    let x = e.touches[0].clientX - rect.left;
    let y = e.touches[0].clientY - rect.top;
    imgX += x - lastX;
    imgY += y - lastY;
    lastX = x; lastY = y;
    drawCanvas();
  }
  if(e.touches.length===2 && pinchStart) {
    let now = [
      {x:e.touches[0].clientX, y:e.touches[0].clientY},
      {x:e.touches[1].clientX, y:e.touches[1].clientY}
    ];
    let dist0 = Math.hypot(
      pinchStart[0].x-pinchStart[1].x,
      pinchStart[0].y-pinchStart[1].y);
    let distN = Math.hypot(
      now[0].x-now[1].x,
      now[0].y-now[1].y);
    scale = pinchInit.scale * (distN/dist0);
    let angle0 = Math.atan2(
      pinchStart[1].y-pinchStart[0].y,
      pinchStart[1].x-pinchStart[0].x);
    let angleN = Math.atan2(
      now[1].y-now[0].y,
      now[1].x-now[0].x);
    rotation = pinchInit.rotation + (angleN-angle0);
    let center0 = {
      x: (pinchStart[0].x+pinchStart[1].x)/2,
      y: (pinchStart[0].y+pinchStart[1].y)/2
    };
    let centerN = {
      x: (now[0].x+now[1].x)/2,
      y: (now[0].y+now[1].y)/2
    };
    imgX = pinchInit.imgX + (centerN.x-center0.x);
    imgY = pinchInit.imgY + (centerN.y-center0.y);
    drawCanvas();
  }
}, {passive:false});

function openUploadModal(student_id) {
  uploadStuId = student_id;
  document.getElementById('upload-modal-bg').style.display = 'flex';
  document.getElementById('upload-file').value = '';
  img = null;
  drawCanvas();
  setUploadMsg('');
}
function closeUploadModal() {
  document.getElementById('upload-modal-bg').style.display = 'none';
  uploadStuId = null;
  img = null;
}
async function submitCanvasImage(){
  if(!img || !uploadStuId) { setUploadMsg('請先選擇圖片'); return; }
  setUploadMsg('上傳中...');
  canvas.toBlob(async function(blob) {
    const ext = 'png';
    const filePath = `student-images/${uploadStuId}/front.${ext}`;
    await client.storage.from('student-img').remove([filePath]);
    const { error: uploadErr } = await client.storage.from('student-img').upload(filePath, blob, { upsert: true });
    if (uploadErr) { 
      console.log('uploadErr', uploadErr); 
      setUploadMsg('圖片上傳失敗');
      return; }
    const { data: { publicUrl } } = client.storage.from('student-img').getPublicUrl(filePath);
    await client.from('student_images').delete().eq('student_id', uploadStuId).eq('image_type', 'front');
    const { error: insertErr } = await client.from('student_images').insert([
      {
        student_id: uploadStuId,
        image_type: 'front',
        image_url: publicUrl,
        uploaded_by: player.player_id
      }
    ]);
    if (insertErr) { setUploadMsg('資料寫入失敗'); return; }
    setUploadMsg('上傳完成！');
    // 先 reload 圖片、再 render（保證頭像新）
    setTimeout(async () => {
      closeUploadModal();
      await reloadImages();
      renderStudentList();
    }, 1000);
  }, 'image/png');
}
window.openUploadModal = openUploadModal;
window.closeUploadModal = closeUploadModal;
window.submitCanvasImage = submitCanvasImage;

// ========== 主邏輯 ==========
async function init() {
  setMsg('載入中...');
  let { data: userData } = await client.auth.getUser();
  if (!userData.user) { location.href = 'login.html'; return; }
  user = userData.user;
  let { data: players, error: pErr } = await client.from('players').select('player_id,username,role').eq('email', user.email).single();
  if (pErr || !players) { location.href = 'login.html'; return; }
  player = players;
  userRole = players.role || "player";

let { data: students, error: sErr } = await client.from('students')
  .select('student_id,name,nickname,student_code,alignment')
  .eq('player_id', player.player_id);
  if (sErr) { setMsg('角色載入失敗'); return; }
  myStudents = students || [];

  let { data: reviews } = await client.from('student_reviews')
    .select('student_id,status');
  reviewMap = {};
  (reviews||[]).forEach(r=>{ reviewMap[r.student_id]=r.status; });

  await reloadImages();
  renderStudentList();
  setMsg('');
}

// 卡片渲染（根據需求重寫）
function renderStudentList() {
  const listWrap = document.getElementById('student-list');
  listWrap.innerHTML = '';
  let studentsWithCode = myStudents.filter(s => s.student_code).sort((a,b)=>(+a.student_code)-(+b.student_code));
  let studentsNoCode = myStudents.filter(s => !s.student_code);
  let all = [...studentsNoCode, ...studentsWithCode];

  all.forEach(stu => {
    let status = reviewMap[stu.student_id] || "";
    let align = stu.alignment==="white" ? "w" : (stu.alignment==="black" ? "b" : "");
    let card = document.createElement('div');
    card.className = "student-card" + (align ? ` card-${align}` : "");

    let avatarUrl = imgMap[stu.student_id] || "https://fakeimg.pl/300x300?text=No+Photo";
    let avatarDiv = document.createElement('div');
    avatarDiv.className = 'avatar-frame';
    let avatarImg = document.createElement('img');
    avatarImg.className = 'avatar-img';
    getAvatarFromUrl(avatarUrl, src=>{
      avatarImg.src = src || "https://fakeimg.pl/300x300?text=No+Photo";
    });
    avatarDiv.appendChild(avatarImg);

    // 卡片主資訊
    let infoDiv = document.createElement('div');
    infoDiv.className = 'student-info';
    infoDiv.innerHTML = `
  <div class="student-name">${stu.student_code ? `NO.${stu.student_code} ` : ""}${stu.nickname || stu.name}</div>
    `;

    // 操作按鈕群
    let btnGroup = document.createElement('div');
    btnGroup.className = 'card-btn-group';

    // 測試學生證
    if (TEST_STUDENT_IDS.includes(stu.student_id)) {
      let btnTest = document.createElement('button');
      btnTest.className = 'btn btn-link';
      btnTest.innerText = '角色卡';
      btnTest.onclick = ()=>window.open(`https://shierusha.github.io/school-battle/students/st-idcard?stu=${stu.student_id}`,'_blank');
      btnGroup.appendChild(btnTest);
    }
    // 學生證
    if (status==="PASS" && stu.student_code) {
      let btnCert = document.createElement('button');
      btnCert.className = 'btn btn-link';
      btnCert.innerText = '學生證';
      btnCert.onclick = ()=>window.open(`https://shierusha.github.io/school-battle/students/st-idcard?stu=${stu.student_code}`,'_blank');
      btnGroup.appendChild(btnCert);
    }
    // 補充設定（只有PASS才有）
    if (status==="PASS") {
      let btnExtra = document.createElement('button');
      btnExtra.className = 'btn btn-link';
      btnExtra.innerText = '申請補充設定';
      btnExtra.onclick = ()=>window.open('https://forms.gle/uE5L8PdJkEWBGhCW6', '_blank');
      btnGroup.appendChild(btnExtra);
    }
    // 修改/上傳照片（BAD or 無狀態才顯示）
    if (status==="BAD" || !status) {
      let btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit';
      btnEdit.innerText = '修改';
      btnEdit.onclick = ()=>openStudentCard(stu.student_id);
      btnGroup.appendChild(btnEdit);

      let btnPhoto = document.createElement('button');
      btnPhoto.className = 'btn';
      btnPhoto.innerText = '上傳照片';
      btnPhoto.onclick = ()=>openUploadModal(stu.student_id);
      btnGroup.appendChild(btnPhoto);
    }
    // 攜帶物
    let devBtn = document.createElement('button');
    devBtn.className = 'btn btn-link';
    devBtn.innerText = '攜帶物(開發中)';
    devBtn.disabled = true;
    btnGroup.appendChild(devBtn);

    card.appendChild(avatarDiv);
    card.appendChild(infoDiv);
    card.appendChild(btnGroup);
    listWrap.appendChild(card);
  });
}

// 其他共用
function openStudentCard(student_id) {
  window.open(`https://shierusha.github.io/create-student/stidcard/shierusha-stu?stu=${student_id}`, "_blank");
}
function goBack() {
  if (userRole === "admin") {
    location.href = 'https://shierusha.github.io/login/admin.html';
  } else {
    location.href = 'player.html';
  }
}
window.openStudentCard = openStudentCard;
window.goBack = goBack;

init();


  </script>
</body>
</html>
