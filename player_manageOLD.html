<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>謝爾夏｜角色管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  font-family: 'Noto Sans TC', sans-serif;
  background: #f4f7fa;
  margin: 0;
  padding: 2rem;
}
.container {
  max-width: 900px;
  margin: auto;
  background: white;
  padding: 2rem;
  border-radius: 1.3rem;
  box-shadow: 0 2px 16px #0001;
}
h2 { text-align: center; margin-bottom: 1.3rem; }
.msg { min-height: 1.5em; margin-bottom: 0.8em; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
th, td { border-bottom: 1px solid #eef2fa; padding: 0.44em 0.63em; text-align: left; }
th { background: #f4f7fa; font-size: 1em;}
.btn {
  background: #1767a0;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.3em 0.8em;
  font-weight: 600;
  cursor: pointer;
  margin-right: 0.2em;
}
.btn-edit { background: #21694b; }
.btn-link { background: #346689; }

.modal-bg {
  display: none;
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.22);
  z-index: 1001;
  justify-content: center;
  align-items: center;
  overflow-y: auto;
}
.modal-bg[style*="flex"], .modal-bg[style*="display: flex"] { display: flex !important;}

.modal {
  position: relative;
  background: #fff;
  border-radius: 1em;
  max-width: 95vw;
  min-width: 260px;
  max-height: 95vh;
  overflow-y: auto;
  box-sizing: border-box;
  padding: 2em 1.5em;
  box-shadow: 0 4px 24px #0004;
}
.modal h3 { margin-top: 0; margin-bottom: 1em; }
.modal .note-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7em; }
.modal .note-content { flex: 1; margin-right: 1em; white-space: pre-line; word-break: break-all; }
.modal input[type="checkbox"] { transform: scale(1.2); }
.modal .close-btn {
  position: absolute;
  top: 0.6em;
  right: 1em;
  background: none;
  border: none;
  font-size: 1.6em;
  color: #999;
  cursor: pointer;
  z-index: 1001;
}
.modal .close-btn:hover { color:#e2583e; }
.modal .modal-actions { margin-top: 1.3em; text-align: right; }
.modal .btn { margin: 0; }

#canvas-wrap {
  position: relative;
  width: min(90vw, 400px);
  height: min(calc(90vw * 9 / 8), 450px);
  max-width: 400px;
  max-height: 450px;
  aspect-ratio: 8 / 9;
  margin: auto;
  touch-action: none;
  background: transparent;
}
#edit-canvas, #redbox-frame {
  width: 100% !important;
  height: 100% !important;
  display: block;
}
#edit-canvas {
  background: #ddd;
  border-radius: 0.7em;
}
#redbox-frame {
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 10;
}
#upload-msg { color: #1d4076; margin-top: 0.8em; }
.hint { font-size: 0.95em; color: #888; margin-top: 0.7em; }

@media (max-width: 650px) {
  .container { padding: 1em; }
  .modal { padding: 1.2em; min-width: 0; max-width: 99vw; }
  #canvas-wrap {
    width: min(99vw, 400px);
    height: min(calc(99vw * 9 / 8), 450px);
    max-width: 400px;
    max-height: 450px;
  }
}

</style>
</head>
<body>
  <div class="container">
    <h2>角色管理</h2>
    <span class="msg" id="msg"></span>
    <div class="table-wrap">
      <table id="data-table">
        <thead>
          <tr>
            <th>名字</th>
            <th>性別</th>
            <th>陣營</th>
            <th>狀態</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="data-tbody"></tbody>
      </table>
    </div>
    <div style="text-align: right;">
      <button class="btn" id="back-btn" onclick="goBack()">返回</button>
    </div>
  </div>

  <!-- 公開設定Modal -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal" id="modal">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h3>公開狀態設定</h3>
      <div id="notes-list"></div>
      <div class="modal-actions">
        <button class="btn btn-edit" onclick="saveNotes()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 上傳正面照 Modal -->
  <div class="modal-bg" id="upload-modal-bg" style="display:none;">
    <div class="modal">
      <button class="close-btn" onclick="closeUploadModal()">×</button>
      <h3 style="text-align:center;">上傳照片</h3>
      <div id="canvas-wrap">
        <canvas id="edit-canvas" width="400" height="450"></canvas>
        <img src="https://shierusha.github.io/create-student/imgs/export-0.png" 
             id="redbox-frame" alt="紅框定位圖">
      </div>
      <input type="file" id="upload-file" accept="image/*"><br>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="submitCanvasImage()">儲存上傳</button>
      </div>
      <div id="upload-msg"></div>
      <div class="hint">電腦可用 AD旋轉 滑鼠滾輪陀移放大縮小<br>手機可用手指縮放、旋轉、移動照片對好臉再上傳</div>
    </div>
  </div>
  <script>

    // ========== Supabase 設定 ==========
const client = window.supabase.createClient(
  'https://wfhwhvodgikpducrhgda.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8'
);
let user = null, player = null, myStudents = [], reviewMap = {}, userRole = "player";
let uploadStuId = null;

// ========== Canvas 功能 ==========
let img = null;
let imgX = 200, imgY = 225, scale = 1, rotation = 0;
let dragging = false, lastX, lastY;
let pinchStart = null, pinchInit = {};
const canvas = document.getElementById('edit-canvas');
const ctx = canvas.getContext('2d');
function setUploadMsg(msg) {
  document.getElementById('upload-msg').textContent = msg || '';
}
function drawCanvas() {
  ctx.clearRect(0,0,400,450);
  if (!img) return;
  ctx.save();
  ctx.translate(imgX, imgY);
  ctx.rotate(rotation);
  ctx.scale(scale, scale);
  ctx.drawImage(img, -img.width/2, -img.height/2);
  ctx.restore();
}
document.getElementById('upload-file').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    img = new Image();
    img.onload = function() {
      imgX = 200; imgY = 225; scale = Math.max(400/img.width, 450/img.height); rotation = 0;
      drawCanvas();
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
};
// 滑鼠拖拉
canvas.onmousedown = function(e){
  if(!img) return;
  dragging = true;
  lastX = e.offsetX;
  lastY = e.offsetY;
};
canvas.onmouseup = canvas.onmouseleave = ()=>dragging=false;
canvas.onmousemove = function(e){
  if(!dragging) return;
  imgX += e.offsetX - lastX;
  imgY += e.offsetY - lastY;
  lastX = e.offsetX; lastY = e.offsetY;
  drawCanvas();
};
// 滾輪縮放
canvas.onwheel = function(e){
  if(!img) return;
  e.preventDefault();
  let factor = (e.deltaY < 0) ? 1.04 : 0.96;
  scale *= factor;
  drawCanvas();
};
// 鍵盤旋轉
window.onkeydown = function(e){
  if(!img) return;
  if(e.key==='a') {rotation -= Math.PI/60; drawCanvas();}
  if(e.key==='d') {rotation += Math.PI/60; drawCanvas();}
};
// 手機觸控
canvas.addEventListener('touchstart', function(e){
  if(!img) return;
  if(e.touches.length===1) {
    dragging = true;
    let rect = canvas.getBoundingClientRect();
    lastX = e.touches[0].clientX - rect.left;
    lastY = e.touches[0].clientY - rect.top;
  }
  if(e.touches.length===2) {
    pinchStart = [
      {x:e.touches[0].clientX, y:e.touches[0].clientY},
      {x:e.touches[1].clientX, y:e.touches[1].clientY}
    ];
    pinchInit = {scale, rotation, imgX, imgY};
  }
}, {passive:false});
canvas.addEventListener('touchend', function(e){
  dragging = false; pinchStart=null;
}, {passive:false});
canvas.addEventListener('touchmove', function(e){
  if(!img) return;
  e.preventDefault();
  let rect = canvas.getBoundingClientRect();
  if(e.touches.length===1 && dragging) {
    let x = e.touches[0].clientX - rect.left;
    let y = e.touches[0].clientY - rect.top;
    imgX += x - lastX;
    imgY += y - lastY;
    lastX = x; lastY = y;
    drawCanvas();
  }
  if(e.touches.length===2 && pinchStart) {
    let now = [
      {x:e.touches[0].clientX, y:e.touches[0].clientY},
      {x:e.touches[1].clientX, y:e.touches[1].clientY}
    ];
    let dist0 = Math.hypot(
      pinchStart[0].x-pinchStart[1].x,
      pinchStart[0].y-pinchStart[1].y);
    let distN = Math.hypot(
      now[0].x-now[1].x,
      now[0].y-now[1].y);
    scale = pinchInit.scale * (distN/dist0);
    let angle0 = Math.atan2(
      pinchStart[1].y-pinchStart[0].y,
      pinchStart[1].x-pinchStart[0].x);
    let angleN = Math.atan2(
      now[1].y-now[0].y,
      now[1].x-now[0].x);
    rotation = pinchInit.rotation + (angleN-angle0);
    let center0 = {
      x: (pinchStart[0].x+pinchStart[1].x)/2,
      y: (pinchStart[0].y+pinchStart[1].y)/2
    };
    let centerN = {
      x: (now[0].x+now[1].x)/2,
      y: (now[0].y+now[1].y)/2
    };
    imgX = pinchInit.imgX + (centerN.x-center0.x);
    imgY = pinchInit.imgY + (centerN.y-center0.y);
    drawCanvas();
  }
}, {passive:false});

function openUploadModal(student_id) {
  uploadStuId = student_id;
  document.getElementById('upload-modal-bg').style.display = 'flex';
  document.getElementById('upload-file').value = '';
  img = null;
  drawCanvas();
  setUploadMsg('');
}
function closeUploadModal() {
  document.getElementById('upload-modal-bg').style.display = 'none';
  uploadStuId = null;
  img = null;
}
function submitCanvasImage(){
  if(!img || !uploadStuId) { setUploadMsg('請先選擇圖片'); return; }
  setUploadMsg('上傳中...');
  canvas.toBlob(async function(blob) {
    const ext = 'png';
    const filePath = `student-images/${uploadStuId}/front.${ext}`;
    await client.storage.from('student-img').remove([filePath]);
    const { error: uploadErr } = await client.storage.from('student-img').upload(filePath, blob, { upsert: true });
    if (uploadErr) { 
      console.log('uploadErr', uploadErr); 
      setUploadMsg('圖片上傳失敗');
      return; }
    const { data: { publicUrl } } = client.storage.from('student-img').getPublicUrl(filePath);
    await client.from('student_images').delete().eq('student_id', uploadStuId).eq('image_type', 'front');
    const { error: insertErr } = await client.from('student_images').insert([
      {
        student_id: uploadStuId,
        image_type: 'front',
        image_url: publicUrl,
        uploaded_by: player.player_id
      }
    ]);
    if (insertErr) { setUploadMsg('資料寫入失敗'); return; }
    setUploadMsg('上傳完成！');
    setTimeout(() => { closeUploadModal(); renderTable(); }, 1300);
  }, 'image/png');
}

// =================== 你本的管理邏輯 ===================
async function init() {
  setMsg('載入中...');
  let { data: userData } = await client.auth.getUser();
  if (!userData.user) { location.href = 'login.html'; return; }
  user = userData.user;
  let { data: players, error: pErr } = await client.from('players').select('player_id,username,role').eq('email', user.email).single();
  if (pErr || !players) { location.href = 'login.html'; return; }
  player = players;
  userRole = players.role || "player";
  let { data: students, error: sErr } = await client.from('students')
    .select('student_id,name,gender,alignment')
    .eq('player_id', player.player_id);
  if (sErr) { setMsg('角色載入失敗'); return; }
  myStudents = students || [];
  let { data: reviews } = await client.from('student_reviews')
    .select('student_id,status');
  reviewMap = {};
  (reviews||[]).forEach(r=>{ reviewMap[r.student_id]=r.status; });
  renderTable();
  setMsg('');
}
function renderTable() {
  const tbody = document.getElementById('data-tbody');
  tbody.innerHTML = '';
  myStudents.forEach(stu => {
    const reviewStatus = getReviewStatus(reviewMap[stu.student_id]);
    tbody.innerHTML += `
      <tr>
        <td>${stu.name}</td>
        <td>${getGender(stu.gender)}</td>
        <td>${getAlignment(stu.alignment)}</td>
        <td>${reviewStatus}</td>
        <td>
          <button class="btn btn-link" onclick="openStudentCard('${stu.student_id}')">學生證</button>
          <button class="btn btn-edit" onclick="openNotesModal('${stu.student_id}')">公開設定</button>
          <button class="btn" onclick="openUploadModal('${stu.student_id}')">上傳證件照</button>
        </td>
      </tr>
    `;
  });
}
function getGender(g) {
  if (g === "M") return "男";
  if (g === "F") return "女";
  if (g === "O") return "其他";
  return "-";
}
function getAlignment(a) {
  if (a === "white") return "白";
  if (a === "black") return "黑";
  return a || "-";
}
function getReviewStatus(s) {
  if (s === "WAIT") return "審核中";
  if (s === "PASS") return "已通過";
  if (s === "BAD") return "未通過";
  return "未審核";
}
function openStudentCard(student_id) {
  window.open(`https://shierusha.github.io/create-student/stidcard/shierusha-stu?stu=${student_id}`, "_blank");
}

// ========== 公開設定 Modal ==========
let currentStuId = null, notesCache = [];
async function openNotesModal(student_id) {
  currentStuId = student_id;
  document.getElementById('modal-bg').style.display = 'flex';
  setModalMsg("載入中...");
  let { data: notes, error } = await client.from('student_notes')
    .select('note_id,content,is_public')
    .eq('student_id', student_id);
  notesCache = notes || [];
  renderNotesList();
  setModalMsg("");
}
function closeModal() {
  document.getElementById('modal-bg').style.display = 'none';
  notesCache = [];
  currentStuId = null;
}
function renderNotesList() {
  let html = '';
  if (!notesCache.length) html = '<div style="color:#888;">沒有筆記</div>';
  notesCache.forEach(n => {
    html += `
      <div class="note-row">
        <div class="note-content">${n.content}</div>
        <input type="checkbox" ${n.is_public ? 'checked' : ''} data-nid="${n.note_id}" onchange="toggleNotePublic(this)">
        <label>公開</label>
      </div>
    `;
  });
  document.getElementById('notes-list').innerHTML = html;
}
function toggleNotePublic(cb) {
  const nid = cb.getAttribute('data-nid');
  const note = notesCache.find(n => n.note_id === nid);
  if (note) note.is_public = cb.checked;
}
async function saveNotes() {
  setModalMsg("儲存中...");
  let ok = true;
  for (let n of notesCache) {
    let { error } = await client.from('student_notes').update({ is_public: n.is_public }).eq('note_id', n.note_id);
    if (error) ok = false;
  }
  setModalMsg(ok ? "儲存完成！" : "部分筆記儲存失敗");
  setTimeout(closeModal, 900);
}
function setMsg(msg) {
  document.getElementById('msg').textContent = msg || '';
}
function setModalMsg(msg) {
  document.getElementById('notes-list').style.color = msg ? "#1d4076" : "";
  if (msg) document.getElementById('notes-list').innerHTML = msg;
}
function goBack() {
  if (userRole === "admin") {
    location.href = 'https://shierusha.github.io/login/admin.html';
  } else {
    location.href = 'player.html';
  }
}

window.openStudentCard = openStudentCard;
window.openNotesModal = openNotesModal;
window.closeModal = closeModal;
window.toggleNotePublic = toggleNotePublic;
window.saveNotes = saveNotes;
window.goBack = goBack;

init();

  </script>
</body>
</html>
